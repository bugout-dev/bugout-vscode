<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!--
        Use a content security policy to only allow loading images from https or from our extension directory,
        and only allow scripts that have a specific nonce.
    -->
    <!--<meta http-equiv="Content-Security-Policy" content="default-src 'none'; font-src ${codiconsFontUri}; style-src ${webview.cspSource} ${codiconsUri};">-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat Coding</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link id ="highlightStyle" href="{{ vscodehighlight }}"  rel="stylesheet" />
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"> -->
    <style>


        #statistics_container {
                
        }
        #search_score, #edit {
            position:absolute;
            right:0;
        }
        #updated_at,#search_score {
            display:inline;
        }
        #search_score {
            position:absolute;
            right:0;
        }

        hr.solid {
            border-top: 4px solid #000;
            border-color: rgba(90, 90, 90, 0.1);
        }

        /* label {
            display: block;
            font: 1rem 'Fira Sans', sans-serif;
        } */
        
        #search
         {
            width: 100%;
            margin: .4rem 0;
            border-radius: 3px;
            padding: 5px;
        }
        #journals {
            -webkit-appearance: button;
            -moz-appearance: button;
            -webkit-user-select: none;
            -moz-user-select: none;
            -webkit-padding-end: 20px;
            -moz-padding-end: 20px;
            -webkit-padding-start: 2px;
            -moz-padding-start: 2px;
            background-position: center right;
            background-repeat: no-repeat;
            border-radius: 2px;
            box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.1);
            font-size: inherit;
            border-width: 2px;
            border-color: -internal-light-dark-color(rgb(118, 118, 118), rgb(195, 195, 195));
            margin: .4rem 0;
            border-radius: 3px;
            padding: 5px;
            overflow: hidden;
            padding-top: 2px;
            padding-bottom: 2px;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>

    <script>
        
        const vscode = acquireVsCodeApi();

        var tags_preload = {{{ tags_option }}};


        var current_search_state = {{ json_data }};
        
        window.addEventListener('message', event => {
            const message = event.data; // The JSON data our extension sent

            switch (message.command) {
                case 'update':
                    console.log(message.highlightStyle);
                    document.getElementById('highlightStyle').href = message.highlightStyle;
            }
        });

        function useAdvise() {
                let text_ = document.querySelector("#search").value;
                let e = document.getElementById("journals");
                let journal = getSelectedOption(e).value;
                vscode.postMessage({command: 'search', query: text_, journal: journal })
        }

        function getSelectedOption(sel) {
            var opt;
            for ( var i = 0, len = sel.options.length; i < len; i++ ) {
                opt = sel.options[i];
                if ( opt.selected === true ) {
                    break;
                }
            }
            return opt;
        }



    
    </script>


    <script src="{{{ jquery_js_uri }}}"></script>
    <link rel="stylesheet" href="{{{ fastselect_css_uri }}}">
    <script src="{{{ fastsearch_js_uri }}}"></script>
    <script src="{{{ fastselect_js_uri }}}"></script>
</head>
<body>
    <br>

<div id="query" data= "{{{ query }}}"></div>

<div id="icons">
    <div>
    <input type="search" id="search" name="q"
    aria-label="Search" placeholder="Search.." value="{{ query }}">
    
        <script>

            let search_input = document.querySelector("#search");

            search_input.addEventListener("keyup", function(event) {
                    // Number 13 is the "Enter" key on the keyboard
                    if (event.keyCode === 13) {
                    // Cancel the default action, if needed
                    event.preventDefault();
                    // Trigger the button element with a click
                    useAdvise();
                }
            });



            function addTab(textarea) {
                        // caching some values, because they are changing as text changes
                        var value = textarea.value,
                            start = textarea.selectionStart,
                            end = textarea.selectionEnd;

                        // adding tab character to actual cursor position
                        textarea.value = value.substring(0, start) + tabChar + value.substring(end);

                        // putting cursor back to its original position
                        textarea.selectionStart = textarea.selectionEnd = start + tabChar.length;
                    }

            function removeTab(textarea) {
                var curPos = textarea.selectionStart,
                    lines = textarea.value.split('\n'),
                    newValue = '',
                    done = false,
                    cnt = 0;

                for (var i = 0, l = lines.length; i < l; i++) {
                    // iterating through each line
                    var line = lines[i];
                    cnt += line.length;
                    if (cnt >= curPos && !done) {
                        // cursor is in this line
                        var newLine = line.replace(new RegExp('^' + tabChar, ''), '');

                        if (newLine !== line) {
                            // there was a tab at the beginning of the line, replace was succesfull, cursor must be moved backwards some
                            line = newLine;
                            curPos -=tabChar.length;
                        }

                        done = true; // only one substitution per run
                    }

                    newValue += line + '\n';
                }

                // setting new value
                textarea.value = newValue;

                // putting cursor back to its original position
                textarea.selectionStart = textarea.selectionEnd = curPos;
            }
        </script>
    </div>

    <div>
        <!-- journal selector -->
        <select class="form-control" name="journals" id="journals">

            {{#each journals}}
                <option value="{{ id }}">{{name}}</option>
            {{/each}}

        </select>
    </div>

        <!-- Swith to editing -->
        <script>
            function entryToediting (button)
            { 
                
                console.log(button);
                var entry_id = button.getAttribute('value');
                var entry_index = button.getAttribute('index');
                var query = document.querySelector("#search").value;
 

                vscode.postMessage({command: 'editing',
                                    query: query,
                                    entries: current_search_state,
                                    title: window['entry_'+entry_index].title,
                                    content: window['entry_'+entry_index].content,
                                    tags: window['entry_'+entry_index].tags.join(','),
                                    editing: entry_index,
                                    entry_id: entry_id,
                                    journal_id: window['entry_'+entry_index].entry_url.split('/')[4]})


                // document.getElementById(entry_id).style.display = 'none';
                // var text_area = document.getElementById('editor_'+entry_id);
                // text_area.style.display = 'block';

                // var tags_input = document.getElementById( 'tags_'+ entry_id );
                // tags_input.removeAttribute("style")
                // var initial_tags = [];

                // for (tag of window['entry_'+entry_index].tags) {
                //     initial_tags.push({'text': tag, 'value':tag});
                // }

                // //tags_input.setAttribute('data-initial-value', JSON.stringify(initial_tags));
                // console.log(tags_input);
                // $('.tags_input_'+ entry_id ).fastselect();

            }
        </script>




        {{#each data}}
            <br>

            <div id="{{ entry_id }}">
                <script>var entry_{{{ index }}} = {{ html_object }};</script>

                <button id="edit" style="background-color:rgba(118, 118, 118, 0)" onclick="entryToediting(this)" index="{{{ index }}}" value="{{{ entry_id }}}">✏️</button>
                <div> {{{ rendered_title }}} </div>
                <div> {{{ rendered_tags }}} </div>
                <div> {{{ rendered_content }}} </div>
                <div id="statistics_container">
                    <div id="updated_at"> {{{ rendered_date }}} </div>
                    <div id="search_score"> {{{ rendered_score }}} </div>
                </div>
            </div>
            <br>
            <hr class="solid">
        {{/each}}
    </div>

</body>
</html>